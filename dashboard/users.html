<section id="users-section" class="dashboard-section active">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
            <button id="create-user-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                <i class="fas fa-plus"></i> Create New User
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sort-header" data-sort="name">
                            Name <i class="fas fa-sort"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sort-header" data-sort="email">
                            Email <i class="fas fa-sort"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sort-header" data-sort="savings">
                            Total Savings <i class="fas fa-sort"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Contribution</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sort-header" data-sort="funeral">
                            Funeral Policies <i class="fas fa-sort"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sort-header" data-sort="loans">
                            Loans <i class="fas fa-sort"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Users will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</section>

<script>
    function initUserManagement() {
        // User Management specific initialization
        let currentSort = { field: 'savings', direction: 'desc' };

        // Add click handlers for sortable headers
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('sort-header') || e.target.parentElement.classList.contains('sort-header')) {
                const header = e.target.classList.contains('sort-header') ? e.target : e.target.parentElement;
                const field = header.getAttribute('data-sort');
                
                // Toggle direction if clicking the same field
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'desc'; // Default to descending for new fields
                }
                
                loadUsersData();
            }
        });

        // Create user functionality
        const createUserBtn = document.getElementById('create-user-btn');
        const createUserModal = document.getElementById('create-user-modal');
        const closeCreateUserModal = document.getElementById('close-create-user-modal');
        const cancelCreateUser = document.getElementById('cancel-create-user');
        const createUserForm = document.getElementById('create-user-form');
        
        createUserBtn.addEventListener('click', function() {
            createUserModal.classList.remove('hidden');
        });
        
        closeCreateUserModal.addEventListener('click', function() {
            createUserModal.classList.add('hidden');
        });
        
        cancelCreateUser.addEventListener('click', function() {
            createUserModal.classList.add('hidden');
        });
        
        createUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userName = document.getElementById('user-name').value;
            const userEmail = document.getElementById('user-email').value;
            const userPassword = document.getElementById('user-password').value;
            const userSavings = document.getElementById('user-savings').value || 0;
            
            showLoading('Creating user...');
            
            // Create user with Firebase Auth
            auth.createUserWithEmailAndPassword(userEmail, userPassword)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Create user document in Firestore
                    return db.collection('users').doc(user.uid).set({
                        uid: user.uid,
                        email: userEmail,
                        fullName: userName,
                        totalSavings: parseFloat(userSavings),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        role: 'user'
                    });
                })
                .then(() => {
                    hideLoading();
                    createUserModal.classList.add('hidden');
                    createUserForm.reset();
                    loadUsersData(); // Refresh the users list
                })
                .catch((error) => {
                    hideLoading();
                    showError('User Creation Error', error.message);
                    console.error('Error creating user:', error);
                });
        });

        // Load users data
        loadUsersData();
    }

    function loadUsersData() {
        showLoading('Loading users...');
        
        db.collection('users').get().then((querySnapshot) => {
            const usersTableBody = document.getElementById('users-table-body');
            
            if (querySnapshot.empty) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            No users found.
                        </td>
                    </tr>
                `;
                hideLoading();
                return;
            }
            
            // Create an array to store all user promises
            const userPromises = [];
            const usersData = [];
            
            querySnapshot.forEach((doc) => {
                const user = doc.data();
                user.id = doc.id;
                
                // Get stokvels for this user
                const stokvelPromise = db.collection('users').doc(doc.id).collection('stokvels').get()
                    .then((stokvelsSnapshot) => {
                        user.stokvels = [];
                        stokvelsSnapshot.forEach((stokvelDoc) => {
                            const stokvel = stokvelDoc.data();
                            stokvel.id = stokvelDoc.id;
                            user.stokvels.push(stokvel);
                        });
                    });
                
                // Get funeral policies for this user
                const funeralPromise = db.collection('users').doc(doc.id).collection('funeral').get()
                    .then((funeralSnapshot) => {
                        user.funerals = [];
                        funeralSnapshot.forEach((funeralDoc) => {
                            const funeral = funeralDoc.data();
                            funeral.id = funeralDoc.id;
                            user.funerals.push(funeral);
                        });
                    });
                
                // Get loans for this user
                const loanPromise = db.collection('users').doc(doc.id).collection('loans').get()
                    .then((loansSnapshot) => {
                        user.loans = [];
                        loansSnapshot.forEach((loanDoc) => {
                            const loan = loanDoc.data();
                            loan.id = loanDoc.id;
                            user.loans.push(loan);
                        });
                    });
                
                // Wait for all data to be loaded for this user
                const userDataPromise = Promise.all([stokvelPromise, funeralPromise, loanPromise])
                    .then(() => {
                        usersData.push(user);
                    });
                
                userPromises.push(userDataPromise);
            });
            
            // Wait for all user data to be loaded
            Promise.all(userPromises).then(() => {
                // Sort users based on current sort criteria
                usersData.sort((a, b) => {
                    let aValue, bValue;
                    
                    switch(currentSort.field) {
                        case 'savings':
                            // Calculate total savings for each user
                            aValue = a.stokvels.reduce((total, stokvel) => total + (parseFloat(stokvel.balance) || 0), 0);
                            bValue = b.stokvels.reduce((total, stokvel) => total + (parseFloat(stokvel.balance) || 0), 0);
                            break;
                        case 'funeral':
                            // Sort by number of funeral policies
                            aValue = a.funerals.length;
                            bValue = b.funerals.length;
                            break;
                        case 'loans':
                            // Sort by number of loans
                            aValue = a.loans.length;
                            bValue = b.loans.length;
                            break;
                        case 'name':
                            // Sort by name
                            aValue = (a.fullName || a.name || a.email || '').toLowerCase();
                            bValue = (b.fullName || b.name || b.email || '').toLowerCase();
                            break;
                        case 'email':
                            // Sort by email
                            aValue = (a.email || '').toLowerCase();
                            bValue = (b.email || '').toLowerCase();
                            break;
                        default:
                            return 0;
                    }
                    
                    // Handle comparison based on data type
                    if (typeof aValue === 'number' && typeof bValue === 'number') {
                        return currentSort.direction === 'asc' ? aValue - bValue : bValue - aValue;
                    } else {
                        if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
                        if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
                
                let usersHtml = '';
                
                usersData.forEach((user) => {
                    // Calculate total savings across all stokvels
                    const totalSavings = user.stokvels.reduce((total, stokvel) => {
                        return total + (parseFloat(stokvel.balance) || 0);
                    }, 0);
                    
                    // Find the earliest next contribution date
                    let nextContribution = null;
                    user.stokvels.forEach((stokvel) => {
                        if (stokvel.nextContribution) {
                            const contributionDate = stokvel.nextContribution.toDate 
                                ? stokvel.nextContribution.toDate() 
                                : new Date(stokvel.nextContribution);
                            
                            if (!nextContribution || contributionDate < nextContribution) {
                                nextContribution = contributionDate;
                            }
                        }
                    });
                    
                    usersHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium">${user.fullName || user.name || user.email}</div>
                                <div class="text-sm text-gray-500">${user.stokvels.length} stokvel(s)</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-500">${user.email || 'N/A'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium">${formatCurrency(totalSavings)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-500">${nextContribution ? formatDate(nextContribution) : 'N/A'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-500">${user.funerals.length} funeral(s)</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-500">${user.loans.length} loan(s)</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative inline-block text-left">
                                    <button class="text-green-600 hover:text-green-900 mr-2 edit-user-dropdown" data-id="${user.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <div class="edit-dropdown-menu absolute hidden right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 add-stokvel" data-id="${user.id}">
                                            <i class="fas fa-users text-blue-500"></i> Stokvel
                                        </a>
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 add-funeral" data-id="${user.id}">
                                            <i class="fas fa-monument text-green-500"></i> Funeral
                                        </a>
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 add-loan" data-id="${user.id}">
                                            <i class="fas fa-hand-holding-usd text-purple-500"></i> Loan
                                        </a>
                                    </div>
                                </div>
                                <button class="text-blue-600 hover:text-blue-900 mr-2 view-user" data-id="${user.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 delete-user" data-id="${user.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                usersTableBody.innerHTML = usersHtml;
                
                // Update sort indicators
                document.querySelectorAll('.sort-header i').forEach(icon => {
                    icon.className = 'fas fa-sort';
                });
                
                const currentHeader = document.querySelector(`.sort-header[data-sort="${currentSort.field}"] i`);
                if (currentHeader) {
                    currentHeader.className = currentSort.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                }
                
                // Add event listeners for the dropdown menus
                setupDropdownListeners();
                
                hideLoading();
            }).catch((error) => {
                showError('Data Error', 'Failed to load users. Please refresh the page.');
                console.error('Error loading users:', error);
                hideLoading();
            });
        }).catch((error) => {
            showError('Data Error', 'Failed to load users. Please refresh the page.');
            console.error('Error loading users:', error);
            hideLoading();
        });
    }

    // Setup dropdown listeners
    function setupDropdownListeners() {
        // Toggle dropdowns
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-user-dropdown') || 
                (e.target.parentElement && e.target.parentElement.classList.contains('edit-user-dropdown'))) {
                
                const button = e.target.classList.contains('edit-user-dropdown') ? e.target : e.target.parentElement;
                const userId = button.getAttribute('data-id');
                const dropdown = button.nextElementSibling;
                
                // Close all other dropdowns
                document.querySelectorAll('.edit-dropdown-menu').forEach(menu => {
                    if (menu !== dropdown) {
                        menu.classList.add('hidden');
                    }
                });
                
                // Toggle current dropdown
                dropdown.classList.toggle('hidden');
            } else {
                // Close all dropdowns when clicking elsewhere
                document.querySelectorAll('.edit-dropdown-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });

        // Handle stokvel addition
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-stokvel') || 
                (e.target.parentElement && e.target.parentElement.classList.contains('add-stokvel'))) {
                
                e.preventDefault();
                const button = e.target.classList.contains('add-stokvel') ? e.target : e.target.parentElement;
                const userId = button.getAttribute('data-id');
                
                // Set the user id in the modal
                document.getElementById('create-stokvel-user-id').value = userId;
                
                // Show the modal
                document.getElementById('create-stokvel-modal').classList.remove('hidden');
                
                // Close the dropdown
                document.querySelectorAll('.edit-dropdown-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });
    }
</script>